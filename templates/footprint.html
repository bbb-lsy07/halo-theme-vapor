<!DOCTYPE html>
<html
  th:lang="${#locale.toLanguageTag}"
  xmlns:th="http://www.thymeleaf.org"
  theme="dark"
  class="dark"
  th:with="site_title = ${not #strings.isEmpty(settings.title) ?  settings.title+' - '+site.title  :  #strings.isEmpty(site.subtitle) ? site.title :  site.title +' - ' +site.subtitle }"
>
  <head th:replace="~{modules/head :: head}"></head>

  <!-- 足迹插件专用头部资源 -->
  <th:block>
    <!-- 引入足迹插件样式 -->
    <link rel="stylesheet" type="text/css" th:href="@{/plugins/footprint/assets/static/css/footprint.css(version=${version})}" />
    <link rel="stylesheet" type="text/css" th:href="@{/plugins/footprint/assets/static/font/result.css(version=${version})}" />

    <!-- 引入jQuery -->
    <script type="text/javascript" th:src="@{/plugins/footprint/assets/static/js/jquery-3.6.0.min.js}"></script>

    <!-- 【关键修复1】引入高德地图API前必须先定义安全配置 -->
    <!-- 使用 th:inline="javascript" 确保能读取后台变量 -->
    <script th:inline="javascript">
      window._AMapSecurityConfig = {
        securityJsCode: [[${settings.gaoDeKey}]]
      }
    </script>

    <!-- 加载地图JS -->
    <script type="text/javascript" th:src="|https://webapi.amap.com/maps?v=2.0&key=${settings.gaoDeKey}|"></script>

    <!-- 引入足迹插件JS -->
    <script type="text/javascript" th:src="@{/plugins/footprint/assets/static/js/footprint.js(version=${version})}"></script>

    <!-- 注入配置信息 -->
    <script th:inline="javascript">
      window.FOOTPRINT_CONFIG = {
        amapKey: [[${settings.gaoDeKey}]],
        footprints: [],
        title: [[${settings.title}]] || '足迹',
        logoName: [[${settings.logoName}]] || '足迹',
        describe: [[${settings.describe}]] || '每一处足迹都充满了故事，那是对人生的思考和无限的风光。',
        hsla: [[${settings.hsla}]] || '200, 100%, 50%',
        mapStyle: [[${settings.mapStyle}]] || 'amap://styles/normal'
      };
    </script>
  </th:block>

  <body
    th:classappend="${#authentication.name  != 'anonymousUser' ? ' logged-in' : ''}"
    th:with="contributor = ${contributorFinder.getContributor(#authentication.name)},
      roleNames = ${#annotations.get(contributor, 'rbac.authorization.halo.run/role-names')},
      roleName= ${roleNames == '[]' ? 'super-' : #strings.substring(roleNames,2, #strings.length(roleNames) - 2) }"
  >
    <!-- 只保留header导航 -->
    <th:block th:replace="~{modules/header}" />

    <!-- 足迹显示区域 -->
    <div class="footprint-page" id="footprint-page">
      <div class="footprint-container">
        <!-- 地图容器 -->
        <div id="footprint-map"></div>

        <!-- 左下角Logo和文字 -->
        <div class="logo-container">
          <h1 class="footprint-logo" th:text="${settings.logoName ?: '足迹'}">足迹</h1>
          <p class="footprint-slogan" th:text="${settings.describe ?: '每一处足迹都充满了故事，那是对人生的思考和无限的风光。'}">每一处足迹都充满了故事，那是对人生的思考和无限的风光。</p>
        </div>

        <!-- 底部控制栏 -->
        <div class="map-controls">
          <!-- 图层选择器 -->
          <div class="likcc-layer-selector">
            <button class="likcc-layer-btn" data-type="normal">
              <svg class="likcc-layer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <path d="M9 9h6v6H9z"></path>
              </svg>
              <span>标准图</span>
            </button>
            <button class="likcc-layer-btn active" data-type="satellite">
              <svg class="likcc-layer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
              </svg>
              <span>卫星图</span>
            </button>
          </div>

          <!-- 功能开关 -->
          <div class="likcc-feature-toggles">
            <label class="likcc-toggle-item">
              <input type="checkbox" data-type="road">
              <div class="likcc-toggle-switch">
                <div class="likcc-toggle-slider"></div>
              </div>
              <div class="likcc-toggle-content">
                <span class="likcc-toggle-label">路网</span>
              </div>
            </label>
            <label class="likcc-toggle-item">
              <input type="checkbox" data-type="traffic">
              <div class="likcc-toggle-switch">
                <div class="likcc-toggle-slider"></div>
              </div>
              <div class="likcc-toggle-content">
                <span class="likcc-toggle-label">路况</span>
              </div>
            </label>
          </div>

          <!-- 缩放控制 -->
          <div class="likcc-zoom-controls">
            <button class="likcc-zoom-btn" id="zoom-in">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="M21 21l-4.35-4.35"></path>
                <line x1="11" y1="8" x2="11" y2="14"></line>
                <line x1="8" y1="11" x2="14" y2="11"></line>
              </svg>
            </button>
            <button class="likcc-zoom-btn" id="zoom-out">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="M21 21l-4.35-4.35"></path>
                <line x1="8" y1="11" x2="14" y2="11"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 必要的脚本 -->
    <script
      th:src="@{/assets/dist/main.iife.js?v={version}(version=${theme.spec.version})}"
      type="text/javascript"
    ></script>
    <script
      th:src="@{/assets/lit-dist/vapor-lit-wc.iife.js?v={version}(version=${theme.spec.version})}"
      type="text/javascript"
    ></script>
    <script>
      main.initializeColorScheme("[[${theme.config.style.color_scheme}]]");
    </script>
    <script
      type="text/javascript"
      th:src="@{/assets/js/function.js?ver={version}(version=${theme.spec.version})}"
      id="function-js"
    ></script>

    <!-- 足迹页面交互脚本 -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // 图层切换功能
        const layerBtns = document.querySelectorAll('.likcc-layer-btn');
        layerBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            layerBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            // 这里插件会自动处理地图切换，主要是UI状态变更
          });
        });

        // 缩放控制 (调用高德地图实例)
        document.getElementById('zoom-in').addEventListener('click', function() {
          if(window.mapInstance) window.mapInstance.zoomIn();
        });

        document.getElementById('zoom-out').addEventListener('click', function() {
          if(window.mapInstance) window.mapInstance.zoomOut();
        });

        // 初始化地图
        if (window.FOOTPRINT_CONFIG && typeof initFootprintMap === 'function') {
          initFootprintMap();
        }
      });
    </script>

    <style>
      /* 基础重置 */
      html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; }
      .footprint-page { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
      .footprint-container { position: relative; width: 100%; height: 100%; }
      #footprint-map { width: 100%; height: 100vh; }

      /* 确保header菜单紧贴屏幕顶部 */
      .site-header {
        position: fixed !important;
        top: 0 !important;
        z-index: 1000 !important;
        width: 100% !important;
        padding-top: 1rem !important;
      }

      /* 隐藏高德默认Logo和控件 */
      .amap-logo, .amap-copyright, .amap-controls { display: none !important; }

      /* 隐藏Logo描述窗口 */
      .logo-container {
        display: none !important;
      }

      /* 【关键修复3】底部控件统一布局 - 电脑版也用移动端样式 */
      .map-controls {
        position: absolute !important;
        bottom: 30px !important;
        left: 50% !important;
        right: auto !important;
        top: auto !important;
        z-index: 999 !important;
        display: flex !important;
        flex-direction: row !important;
        align-items: flex-end !important;
        gap: 0 !important;
        background: transparent !important;
        box-shadow: none !important;
        padding: 0 !important;
        width: 90% !important;
        border: none !important;
        backdrop-filter: none !important;
        transform: translateX(-50%) !important;
        justify-content: space-between !important;
      }

      /* 独立的胶囊样式 */
      .likcc-layer-selector,
      .likcc-feature-toggles,
      .likcc-zoom-controls {
        background: rgba(255, 255, 255, 0.9) !important;
        backdrop-filter: blur(10px) !important;
        border-radius: 12px !important;
        padding: 6px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid rgba(255, 255, 255, 0.5) !important;
        display: flex !important;
        align-items: center !important;
        margin: 0 !important;
      }

      .dark .likcc-layer-selector,
      .dark .likcc-feature-toggles,
      .dark .likcc-zoom-controls {
        background: rgba(30, 30, 30, 0.9) !important;
        border-color: rgba(255, 255, 255, 0.1) !important;
      }

      /* 左右分开布局 */
      .likcc-zoom-controls { order: 1 !important; }
      .likcc-layer-selector { order: 2 !important; }
      
      /* 电脑版也隐藏功能开关 */
      .likcc-feature-toggles { display: none !important; }

      /* 按钮微调 */
      .likcc-layer-btn {
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        padding: 8px 12px !important;
        border-radius: 8px !important;
        font-size: 13px !important;
        color: #555 !important;
        background: transparent !important;
        border: none !important;
        cursor: pointer !important;
      }
      .dark .likcc-layer-btn { color: #ccc !important; }

      .likcc-layer-btn.active {
        background: #84cc16 !important;
        color: white !important;
      }
      .likcc-layer-icon { width: 16px !important; height: 16px !important; }

      /* 开关微调 */
      .likcc-toggle-item {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        padding: 4px 8px !important;
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
        margin: 0 !important;
        cursor: pointer !important;
      }

      .likcc-toggle-item input { display: none !important; }

      .likcc-toggle-switch {
        position: relative !important;
        width: 36px !important;
        height: 20px !important;
        background: #e4e4e7 !important;
        border-radius: 20px !important;
        transition: all 0.3s !important;
      }
      .dark .likcc-toggle-switch { background: #555 !important; }

      .likcc-toggle-slider {
        position: absolute !important;
        top: 2px !important;
        left: 2px !important;
        width: 16px !important;
        height: 16px !important;
        background: white !important;
        border-radius: 50% !important;
        transition: all 0.3s !important;
      }

      .likcc-toggle-item input:checked + .likcc-toggle-switch { background: #84cc16 !important; }
      .likcc-toggle-item input:checked + .likcc-toggle-switch .likcc-toggle-slider { transform: translateX(16px) !important; }

      .likcc-toggle-label { font-size: 12px !important; color: #555 !important; }
      .dark .likcc-toggle-label { color: #ccc !important; }

      /* 缩放按钮 */
      .likcc-zoom-controls { flex-direction: row !important; gap: 4px !important; }

      .likcc-zoom-btn {
        width: 32px !important;
        height: 32px !important;
        border-radius: 8px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: transparent !important;
        border: none !important;
        color: #555 !important;
        cursor: pointer !important;
      }
      .dark .likcc-zoom-btn { color: #ccc !important; }
      .likcc-zoom-btn:hover { color: #84cc16 !important; }

      /* 移动端适配 - 保持原有样式 */
      @media (max-width: 768px) {
        /* 按钮简化 - 移动端只显示图标 */
        .likcc-layer-btn span { display: none !important; }
        .likcc-layer-btn { padding: 8px !important; }
      }
    </style>
  </body>
</html>